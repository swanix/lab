<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ejemplo de Uso del Proxy de API - Sistema de Auth</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem;
      line-height: 1.6;
    }
    .container {
      background: #f5f5f5;
      padding: 2rem;
      border-radius: 8px;
      margin: 2rem 0;
    }
    .btn {
      background: #2196f3;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      margin: 0.5rem;
    }
    .btn:hover {
      background: #1976d2;
    }
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .result {
      background: #e8f5e8;
      padding: 1rem;
      border-radius: 4px;
      margin: 1rem 0;
      white-space: pre-wrap;
      font-family: monospace;
    }
    .error {
      background: #ffebee;
      color: #c62828;
      padding: 1rem;
      border-radius: 4px;
      margin: 1rem 0;
    }
    .warning {
      background: #fff3e0;
      color: #ef6c00;
      padding: 1rem;
      border-radius: 4px;
      margin: 1rem 0;
    }
  </style>
</head>
<body>
  <h1>üîê Ejemplo de Uso del Proxy de API</h1>
  
  <div class="container">
    <h2>Estado del Sistema</h2>
    <div id="system-status">Verificando...</div>
    
    <div id="proxy-status" class="warning" style="display: none;">
      <strong>‚ö†Ô∏è Proxy no habilitado:</strong> Para usar el proxy, configura apiProxy.enabled = true en auth-config.js
    </div>
  </div>
  
  <div class="container">
    <h2>Acceso a Datos Protegidos</h2>
    <p>Este ejemplo muestra c√≥mo acceder a datos protegidos usando el proxy integrado en el sistema de autenticaci√≥n.</p>
    
    <div id="auth-required" style="display: none;">
      <p>üîí <strong>Autenticaci√≥n requerida:</strong> Debes iniciar sesi√≥n para acceder a datos protegidos.</p>
      <button class="btn" onclick="Auth.redirectToLogin()">Iniciar Sesi√≥n</button>
    </div>
    
    <div id="proxy-actions" style="display: none;">
      <h3>Ejemplos de Uso</h3>
      
      <button class="btn" onclick="testSheetBestProxy()">
        üìä Probar SheetBest Proxy
      </button>
      
      <button class="btn" onclick="testCustomAPI()">
        üîó Probar API Personalizada
      </button>
      
      <button class="btn" onclick="testUnauthorizedDomain()">
        üö´ Probar Dominio No Autorizado
      </button>
      
      <div id="result-container"></div>
    </div>
  </div>
  
  <div class="container">
    <h2>Configuraci√≥n del Proxy</h2>
    <p>Para habilitar el proxy, modifica <code>auth/assets/auth-config.js</code>:</p>
    
    <pre><code>apiProxy: {
  enabled: true, // Cambiar a true
  endpoint: '/api/proxy',
  serviceName: 'SheetBest',
  allowedDomains: ['api.sheetbest.com']
}</code></pre>
    
    <p>Y configura las variables de entorno en Netlify:</p>
    <pre><code>API_PROXY_KEY=tu-api-key
API_PROXY_ALLOWED_DOMAINS=api.sheetbest.com
API_PROXY_SERVICE_NAME=SheetBest</code></pre>
  </div>
  
  <!-- Cargar configuraci√≥n de auth primero -->
  <script src="/auth/assets/auth-config.js"></script>
  
  <!-- Cargar sistema de autenticaci√≥n -->
  <script src="/auth/assets/auth.js"></script>
  
  <script>
    // Verificar estado del sistema
    function checkSystemStatus() {
      const isAuth = Auth.isAuthenticated();
      const proxyEnabled = getAuthConfig('apiProxy.enabled');
      
      const statusDiv = document.getElementById('system-status');
      const proxyStatusDiv = document.getElementById('proxy-status');
      const authRequiredDiv = document.getElementById('auth-required');
      const proxyActionsDiv = document.getElementById('proxy-actions');
      
      // Mostrar estado de autenticaci√≥n
      if (isAuth) {
        statusDiv.innerHTML = '‚úÖ <strong>Usuario autenticado</strong>';
        authRequiredDiv.style.display = 'none';
        proxyActionsDiv.style.display = 'block';
      } else {
        statusDiv.innerHTML = '‚ùå <strong>Usuario no autenticado</strong>';
        authRequiredDiv.style.display = 'block';
        proxyActionsDiv.style.display = 'none';
      }
      
      // Mostrar estado del proxy
      if (!proxyEnabled) {
        proxyStatusDiv.style.display = 'block';
      } else {
        proxyStatusDiv.style.display = 'none';
      }
    }
    
    // Funci√≥n para mostrar resultados
    function showResult(title, data, isError = false) {
      const container = document.getElementById('result-container');
      const div = document.createElement('div');
      div.className = isError ? 'error' : 'result';
      div.innerHTML = `<strong>${title}:</strong>\n${JSON.stringify(data, null, 2)}`;
      container.appendChild(div);
    }
    
    // Funci√≥n para limpiar resultados
    function clearResults() {
      document.getElementById('result-container').innerHTML = '';
    }
    
    // Probar proxy de SheetBest
    async function testSheetBestProxy() {
      clearResults();
      
      try {
        // URL de ejemplo de SheetBest (reemplazar con una real)
        const url = 'https://api.sheetbest.com/test-endpoint';
        
        showResult('üîÑ Intentando acceso a SheetBest', { url });
        
        const data = await Auth.fetchProtectedData(url);
        showResult('‚úÖ Datos obtenidos de SheetBest', data);
        
      } catch (error) {
        showResult('‚ùå Error en SheetBest Proxy', { error: error.message }, true);
      }
    }
    
    // Probar API personalizada
    async function testCustomAPI() {
      clearResults();
      
      try {
        // URL de ejemplo (debe estar en allowedDomains)
        const url = 'https://api.sheetbest.com/custom-endpoint';
        
        showResult('üîÑ Intentando acceso a API personalizada', { url });
        
        const data = await Auth.fetchProtectedData(url, {
          method: 'POST',
          body: { test: 'data' }
        });
        showResult('‚úÖ Datos obtenidos de API personalizada', data);
        
      } catch (error) {
        showResult('‚ùå Error en API personalizada', { error: error.message }, true);
      }
    }
    
    // Probar dominio no autorizado
    async function testUnauthorizedDomain() {
      clearResults();
      
      try {
        // URL de dominio no autorizado
        const url = 'https://api.otroservicio.com/data';
        
        showResult('üîÑ Intentando acceso a dominio no autorizado', { url });
        
        const data = await Auth.fetchProtectedData(url);
        showResult('‚úÖ Datos obtenidos (no deber√≠a llegar aqu√≠)', data);
        
      } catch (error) {
        showResult('‚ùå Error esperado - Dominio no autorizado', { error: error.message }, true);
      }
    }
    
    // Inicializar
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => {
        checkSystemStatus();
      }, 500);
    });
    
    // Verificar estado cada 30 segundos
    setInterval(checkSystemStatus, 30000);
  </script>
</body>
</html>

